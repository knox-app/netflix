<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Family Account Link</title>
    <!-- Firebase SDK (Compat Version for simplicity) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <!-- EmailJS SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    
    <style>
        :root {
            --bg-color: #1a1c1e;
            --panel-bg: #282a2d;
            --border-color: #3f4448;
            --text-main: #e3e3e3;
            --text-dim: #9aa0a6;
            --accent: #8ab4f8;
            --danger: #f28b82;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-main);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        .card {
            background: var(--panel-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            width: 400px;
            padding: 24px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.4);
        }

        .header {
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 20px;
            padding-bottom: 10px;
        }

        .header h2 { font-size: 18px; font-weight: 500; margin: 0; color: var(--accent); }

        .form-group { margin-bottom: 18px; }
        label { display: block; font-size: 12px; color: var(--text-dim); margin-bottom: 6px; text-transform: uppercase; }

        input, select {
            width: 100%;
            padding: 10px;
            background: #1e1e1e;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            color: white;
            box-sizing: border-box;
            outline: none;
            transition: border 0.2s;
        }

        input:focus { border-color: var(--accent); }

        button {
            width: 100%;
            padding: 12px;
            background: var(--accent);
            color: #202124;
            border: none;
            border-radius: 4px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 10px;
        }

        button:hover { background: #aecbfa; }

        .hidden { display: none; }
        .status { font-size: 13px; margin-top: 15px; text-align: center; color: var(--text-dim); }
        .error { color: var(--danger) !important; }
    </style>
</head>
<body>

<div class="card">
    <div class="header" id="dynamic-title">
        <h2>Minor Account Setup</h2>
    </div>

    <!-- Step 1: Link Guardian -->
    <div id="step-guardian">
        <p style="font-size: 13px; margin-bottom: 20px;">To link this account, provide your Guardian's ID. Their status must be 'off'.</p>
        <div class="form-group">
            <label>Guardian Document ID</label>
            <input type="text" id="parent-id" placeholder="e.g. 7ZBfafWNe...">
        </div>
        <div class="form-group">
            <label>Guardian Email (for OTP)</label>
            <input type="email" id="target-email" placeholder="parent@example.com">
        </div>
        <button onclick="verifyGuardian()">Request Permission</button>
    </div>

    <!-- Step 2: OTP Entry -->
    <div id="step-otp" class="hidden">
        <div class="form-group">
            <label>6-Digit Verification Code</label>
            <input type="text" id="otp-code" maxlength="6" style="text-align:center; font-size: 24px; letter-spacing: 4px;">
        </div>
        <button onclick="checkOTP()">Verify Guardian</button>
    </div>

    <!-- Step 3: Minor Data Collection -->
    <div id="step-details" class="hidden">
        <div class="form-group">
            <label>First Name</label>
            <input type="text" id="fname">
        </div>
        <div class="form-group">
            <label>Last Name</label>
            <input type="text" id="lname">
        </div>
        <div class="form-group">
            <label>Date of Birth</label>
            <input type="date" id="dob">
        </div>
        <div class="form-group">
            <label>Gender</label>
            <select id="gender">
                <option value="Male">Male</option>
                <option value="Female">Female</option>
            </select>
        </div>
        <button onclick="finalizeAccount()">Complete "Commit" Status</button>
    </div>

    <div id="status-msg" class="status">Waiting for URL parameters...</div>
</div>

<script>
    // Firebase Config
    const firebaseConfig = {
        apiKey: "AIzaSyDL7sPp-FkG59L-mRQ7BrCGgeKMhQC80iw",
        authDomain: "xperts-metadata.firebaseapp.com",
        projectId: "xperts-metadata",
        storageBucket: "xperts-metadata.firebasestorage.app",
        messagingSenderId: "514845910910",
        appId: "1:514845910910:web:5a2402130a97b5d749b52f",
        measurementId: "G-CQ5KWGJSZB"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // EmailJS Init
    emailjs.init("Yr9MutUoHOEONnFgn");

    let currentOTP = "";
    let urlId = "";
    let guardianId = "";

    // Initialization: Parse URL for id and Family=commit
    window.onload = function() {
        const params = new URLSearchParams(window.location.search);
        urlId = params.get('id');
        const familyParam = params.get('Family');

        if (urlId && familyParam === 'commit') {
            document.getElementById('status-msg').innerText = "Account ID: " + urlId;
        } else {
            document.body.innerHTML = "<h2 style='color:white; text-align:center; margin-top:50px;'>Invalid URL: Missing ID or Family=commit</h2>";
        }
    };

    async function verifyGuardian() {
        guardianId = document.getElementById('parent-id').value;
        const email = document.getElementById('target-email').value;
        const status = document.getElementById('status-msg');

        if(!guardianId || !email) return alert("Please fill all fields");

        status.innerText = "Checking Guardian status...";
        
        try {
            const doc = await db.collection("users").doc(guardianId).get();
            
            if (doc.exists && doc.data().family === "off") {
                sendOTP(email);
            } else {
                status.classList.add('error');
                status.innerText = "Error: Guardian ID invalid or status is not 'off'.";
            }
        } catch (e) {
            status.innerText = "Error accessing database.";
        }
    }

    function sendOTP(email) {
        currentOTP = Math.floor(100000 + Math.random() * 900000).toString();
        const timeLimit = new Date(new Date().getTime() + 15*60000).toLocaleTimeString();

        const params = {
            passcode: currentOTP,
            time: timeLimit,
            to_email: email
        };

        emailjs.send('service_qiyll9e', 'template_vssk4uu', params)
            .then(() => {
                document.getElementById('step-guardian').classList.add('hidden');
                document.getElementById('step-otp').classList.remove('hidden');
                document.getElementById('status-msg').innerText = "OTP sent to your guardian's email.";
            });
    }

    function checkOTP() {
        const entered = document.getElementById('otp-code').value;
        if(entered === currentOTP) {
            document.getElementById('step-otp').classList.add('hidden');
            document.getElementById('step-details').classList.remove('hidden');
            document.getElementById('status-msg').innerText = "Verification Successful.";
        } else {
            alert("Incorrect OTP");
        }
    }

    async function finalizeAccount() {
        const data = {
            firstName: document.getElementById('fname').value,
            lastName: document.getElementById('lname').value,
            dob: document.getElementById('dob').value,
            gender: document.getElementById('gender').value,
            family: "commit", // Minor account status
            guardianID: guardianId, // Linking to Parent
            id: urlId,
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
        };

        try {
            document.getElementById('status-msg').innerText = "Committing to database...";
            await db.collection("users").doc(urlId).set(data);
            
            document.getElementById('step-details').innerHTML = "<h3>Account Linked Successfully!</h3><p>Status: family=commit</p>";
            document.getElementById('status-msg').innerText = "Data stored and linked to Guardian: " + guardianId;
        } catch (e) {
            alert("Save failed: " + e.message);
        }
    }
</script>
</body>
</html>
